<!DOCTYPE html>
<html lang="es">
<!-- [Mantener todo el head y estilos igual que en la versi√≥n anterior] -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Sensores IoT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gauge.js/1.3.7/gauge.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* [Mantener todos los estilos igual que en la versi√≥n anterior] */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #121212;
            color: #e0e0e0;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .card {
            background-color: #1e1e1e;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .gauge-container {
            width: 300px;
            text-align: center;
        }
        .chart-container {
            width: 100%;
            height: 300px;
        }
        .value-display {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
            color: #ffffff;
        }
        .connection-status {
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            margin-bottom: 20px;
        }
        .connected {
            background-color: #28a745;
            color: #ffffff;
        }
        .disconnected {
            background-color: #dc3545;
            color: #ffffff;
        }
        .settings {
            margin-bottom: 20px;
            text-align: center;
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
        }
        input, button {
            padding: 8px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #333;
            color: #e0e0e0;
        }
        button {
            background-color: #2196F3;
            border: none;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #1976D2;
        }
        .debug-panel {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            margin-top: 20px;
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <h1>Monitor de Sensores IoT</h1>

    <div class="settings">
        <div>
            <label for="host">Host MQTT:</label>
            <input type="text" id="host" value="280b4923bd19408a8100f249fb7b2fdb.s1.eu.hivemq.cloud" style="width: 350px;">
        </div>
        <div>
            <label for="username">Usuario:</label>
            <input type="text" id="username" value="tu_usuario">
            <label for="password">Contrase√±a:</label>
            <input type="password" id="password" value="tu_contrase√±a">
        </div>
        <div>
            <label for="tempTopic">Tema Temperatura:</label>
            <input type="text" id="tempTopic" value="sensores/temperatura">
            <label for="humTopic">Tema Humedad:</label>
            <input type="text" id="humTopic" value="sensores/humedad">
        </div>
        <div>
            <button id="connectBtn" onclick="connectMQTT()">
                <i class="fas fa-plug"></i> Conectar
            </button>
            <button id="disconnectBtn" onclick="disconnectMQTT()">
                <i class="fas fa-power-off"></i> Desconectar
            </button>
        </div>
    </div>

    <div id="connectionStatus" class="connection-status disconnected">
        Desconectado
    </div>

    <div class="container">
        <div class="card gauge-container">
            <h2>Temperatura Actual</h2>
            <canvas id="temperatureGauge"></canvas>
            <div id="temperatureValue" class="value-display">0.00 ¬∞C</div>
        </div>

        <div class="card gauge-container">
            <h2>Humedad Actual</h2>
            <canvas id="humidityGauge"></canvas>
            <div id="humidityValue" class="value-display">0.00 %</div>
        </div>

        <div class="card chart-container">
            <h2>Historial de Temperatura</h2>
            <canvas id="temperatureChart"></canvas>
        </div>

        <div class="card chart-container">
            <h2>Historial de Humedad</h2>
            <canvas id="humidityChart"></canvas>
        </div>
    </div>

    <button onclick="exportData()" class="export-btn">
        <i class="fas fa-download"></i> Exportar Datos
    </button>

    <div class="debug-panel" id="debugPanel"></div>

    <script>
        // Variables globales
        let client = null;
        let temperatureGaugeChart;
        let humidityGaugeChart;
        let temperatureLineChart;
        let humidityLineChart;
        let temperatureHistory = [];
        let humidityHistory = [];
        const maxDataPoints = 30;
        let isConnected = false;
        let reconnectTimeout = null;

        function logDebug(message, type = 'info') {
            console.log(message);
            const debugPanel = document.getElementById('debugPanel');
            const timestamp = new Date().toLocaleTimeString();
            let prefix = '';
            switch(type) {
                case 'mqtt':
                    prefix = 'üîµ MQTT';
                    break;
                case 'error':
                    prefix = 'üî¥ ERROR';
                    break;
                case 'success':
                    prefix = '‚úÖ OK';
                    break;
                default:
                    prefix = '‚ÑπÔ∏è INFO';
            }
            debugPanel.innerHTML = `[${timestamp}] ${prefix}: ${message}<br>` + debugPanel.innerHTML;
        }

        function connectMQTT() {
            if (client && client.isConnected()) {
                disconnectMQTT();
            }

            const host = document.getElementById('host').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const clientId = "mqttjs_" + Math.random().toString(16).substr(2, 8);
                logDebug(`Intentando conectar a ${host}`, 'mqtt');

                // Crear cliente MQTT con la URL correcta para HiveMQ Cloud
                client = new Paho.MQTT.Client(host, 8884, clientId);

                client.onConnectionLost = function(responseObject) {
                    isConnected = false;
                    document.getElementById('connectionStatus').className = 'connection-status disconnected';
                    document.getElementById('connectionStatus').textContent = 'Desconectado';

                    if (responseObject.errorCode !== 0) {
                        logDebug("Conexi√≥n perdida: " + responseObject.errorMessage, 'error');
                    }

                    if (!reconnectTimeout) {
                        reconnectTimeout = setTimeout(connectMQTT, 5000);
                    }
                };

                client.onMessageArrived = function(message) {
                    const topic = message.destinationName;
                    const payload = message.payloadString;
                    logDebug(`Mensaje recibido en tema "${topic}": ${payload}`, 'mqtt');

                    try {
                        const value = parseFloat(payload);
                        if (!isNaN(value)) {
                            if (topic === document.getElementById('tempTopic').value) {
                                updateGauge('temperature', value);
                            } else if (topic === document.getElementById('humTopic').value) {
                                updateGauge('humidity', value);
                            }
                        }
                    } catch (e) {
                        logDebug(`Error al procesar mensaje: ${e.message}`, 'error');
                    }
                };

                // Configuraci√≥n de conexi√≥n segura
                const options = {
                    useSSL: true,
                    timeout: 3,
                    onSuccess: function() {
                        isConnected = true;
                        logDebug("¬°Conexi√≥n exitosa!", 'success');
                        document.getElementById('connectionStatus').className = 'connection-status connected';
                        document.getElementById('connectionStatus').textContent = 'Conectado';

                        // Suscribirse a los temas
                        const tempTopic = document.getElementById('tempTopic').value;
                        const humTopic = document.getElementById('humTopic').value;

                        client.subscribe(tempTopic);
                        client.subscribe(humTopic);
                        logDebug(`Suscrito a ${tempTopic} y ${humTopic}`, 'success');
                    },
                    onFailure: function(e) {
                        isConnected = false;
                        logDebug("Error de conexi√≥n: " + e.errorMessage, 'error');
                        document.getElementById('connectionStatus').className = 'connection-status disconnected';
                        document.getElementById('connectionStatus').textContent = 'Error: ' + e.errorMessage;

                        if (!reconnectTimeout) {
                            reconnectTimeout = setTimeout(connectMQTT, 5000);
                        }
                    },
                    userName: username,
                    password: password
                };

                client.connect(options);

            } catch (e) {
                logDebug("Error al inicializar cliente MQTT: " + e.message, 'error');
            }
        }

        // [Mantener el resto de las funciones igual que en la versi√≥n anterior]
        function disconnectMQTT() {
            if (client && client.isConnected()) {
                client.disconnect();
                isConnected = false;
                logDebug("Desconectado manualmente", 'info');
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
                document.getElementById('connectionStatus').textContent = 'Desconectado manualmente';
                
                if (reconnectTimeout) {
                    clearTimeout(reconnectTimeout);
                    reconnectTimeout = null;
                }
            }
        }

        function updateGauge(type, value) {
            if (type === 'temperature') {
                temperatureGaugeChart.set(value);
                document.getElementById('temperatureValue').textContent = value.toFixed(2) + ' ¬∞C';
            } else if (type === 'humidity') {
                humidityGaugeChart.set(value);
                document.getElementById('humidityValue').textContent = value.toFixed(2) + ' %';
            }
            updateChart(type, value, new Date().getTime());
        }

        function updateChart(type, value, timestamp) {
            const timeStr = new Date(timestamp).toLocaleTimeString();
            const history = type === 'temperature' ? temperatureHistory : humidityHistory;
            const chart = type === 'temperature' ? temperatureLineChart : humidityLineChart;

            history.push({
                time: timeStr,
                value: value
            });

            if (history.length > maxDataPoints) {
                history.shift();
            }

            chart.data.labels = history.map(item => item.time);
            chart.data.datasets[0].data = history.map(item => item.value);
            chart.update();
        }

        // Inicializaci√≥n de los gr√°ficos
        document.addEventListener('DOMContentLoaded', function() {
            // Configuraci√≥n del gauge de temperatura
            temperatureGaugeChart = new Gauge(document.getElementById('temperatureGauge')).setOptions({
                angle: 0,
                lineWidth: 0.3,
                radiusScale: 1,
                pointer: {
                    length: 0.6,
                    strokeWidth: 0.035,
                    color: '#ffffff'
                },
                limitMax: true,
                limitMin: true,
                colorStart: '#1f77b4',
                colorStop: '#ff7f0e',
                strokeColor: '#333',
                generateGradient: true,
                highDpiSupport: true,
                staticLabels: {
                    font: "10px sans-serif",
                    labels: [0, 20, 40, 60, 80, 100],
                    color: "#ffffff"
                },
                staticZones: [
                    {strokeStyle: "#30B32D", min: 0, max: 20},
                    {strokeStyle: "#FFDD00", min: 20, max: 60},
                    {strokeStyle: "#F03E3E", min: 60, max: 100}
                ],
            });
            temperatureGaugeChart.maxValue = 100;
            temperatureGaugeChart.setMinValue(0);
            temperatureGaugeChart.set(0);

            // Configuraci√≥n del gauge de humedad
            humidityGaugeChart = new Gauge(document.getElementById('humidityGauge')).setOptions({
                angle: 0,
                lineWidth: 0.3,
                radiusScale: 1,
                pointer: {
                    length: 0.6,
                    strokeWidth: 0.035,
                    color: '#ffffff'
                },
                limitMax: true,
                limitMin: true,
                colorStart: '#1f77b4',
                colorStop: '#ff7f0e',
                strokeColor: '#333',
                generateGradient: true,
                highDpiSupport: true,
                staticLabels: {
                    font: "10px sans-serif",
                    labels: [0, 20, 40, 60, 80, 100],
                    color: "#ffffff"
                },
                staticZones: [
                    {strokeStyle: "#30B32D", min: 0, max: 30},
                    {strokeStyle: "#FFDD00", min: 30, max: 70},
                    {strokeStyle: "#F03E3E", min: 70, max: 100}
                ],
            });
            humidityGaugeChart.maxValue = 100;
            humidityGaugeChart.setMinValue(0);
            humidityGaugeChart.set(0);

            // Inicializaci√≥n de los gr√°ficos de l√≠nea
            temperatureLineChart = new Chart(document.getElementById('temperatureChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperatura (¬∞C)',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#333'
                            },
                            ticks: {
                                color: '#fff'
                            }
                        },
                        x: {
                            grid: {
                                color: '#333'
                            },
                            ticks: {
                                color: '#fff'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff'
                            }
                        }
                    }
                }
            });

            humidityLineChart = new Chart(document.getElementById('humidityChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Humedad (%)',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#333'
                            },
                            ticks: {
                                color: '#fff'
                            }
                        },
                        x: {
                            grid: {
                                color: '#333'
                            },
                            ticks: {
                                color: '#fff'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff'
                            }
                        }
                    }
                }
            });

            logDebug("Aplicaci√≥n inicializada. Pulse 'Conectar' para iniciar la conexi√≥n MQTT.");
        });
    </script>
</body>
</html>
